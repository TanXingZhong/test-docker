name: Deploy to Single VM (docker-compose)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-vm:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Derive image tag
        id: tag
        run: echo "value=$(bash scripts/image_tag.sh)" >> $GITHUB_OUTPUT

      - name: Write SSH key
        run: |
          echo "${{ secrets.SSH_KEY }}" | base64 -d > id_rsa
          chmod 600 id_rsa

      - name: Copy files & deploy
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          REGISTRY: ${{ secrets.REGISTRY }}
          IMAGE_NAMESPACE: ${{ secrets.IMAGE_NAMESPACE }}
          IMAGE_TAG: ${{ steps.tag.outputs.value }}
        run: |
          # Install docker compose on remote if needed and deploy
          ssh -i id_rsa -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<'EOSSH'
          set -e
          if ! command -v docker >/dev/null; then
            curl -fsSL https://get.docker.com | sh
          fi
          if ! docker compose version >/dev/null 2>&1; then
            DOCKER_CONFIG=${HOME}/.docker
            mkdir -p $DOCKER_CONFIG/cli-plugins
            curl -SL https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
            chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
          fi
          mkdir -p ~/app
          EOSSH

          scp -i id_rsa -o StrictHostKeyChecking=no docker-compose.prod.yml ${SSH_USER}@${SSH_HOST}:~/app/docker-compose.yml

          ssh -i id_rsa -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} <<EOSSH
          set -e
          export REGISTRY="${REGISTRY}"
          export IMAGE_NAMESPACE="${IMAGE_NAMESPACE}"
          export IMAGE_TAG="${IMAGE_TAG}"
          cd ~/app
          echo "REGISTRY=$REGISTRY" > .env
          echo "IMAGE_NAMESPACE=$IMAGE_NAMESPACE" >> .env
          echo "IMAGE_TAG=$IMAGE_TAG" >> .env

          docker login "$REGISTRY" -u "${{ secrets.REGISTRY_USERNAME }}" -p "${{ secrets.REGISTRY_PASSWORD }}"
          docker compose pull
          docker compose up -d
          EOSSH
