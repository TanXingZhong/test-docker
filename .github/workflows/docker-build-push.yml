name: Build & Push Images (Changed Services)

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.REGISTRY }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}

      - name: Detect changed services
        id: changed
        run: |
          BASE_SHA="${{ github.event.before || github.event.pull_request.base.sha || 'HEAD~1' }}"
          HEAD_SHA="${{ github.sha }}"
          services=$(bash scripts/list_changed_services.sh "$BASE_SHA" "$HEAD_SHA" || true)
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "${services}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Changed services:"
          echo "${services}"

      - name: Set image tag
        id: tag
        run: echo "value=$(bash scripts/image_tag.sh)" >> $GITHUB_OUTPUT

      - name: Build & Push (matrix over services)
        if: steps.changed.outputs.services != ''
        run: |
          tag='${{ steps.tag.outputs.value }}'
          registry='${{ secrets.REGISTRY }}'
          ns='${{ secrets.IMAGE_NAMESPACE }}'
          while read svc; do
            [ -z "$svc" ] && continue
            image="${registry}/${ns}/${svc}:${tag}"
            echo "Building $image from services/$svc"
            docker build -t "$image" "services/$svc"
            docker push "$image"
          done <<< "${{ steps.changed.outputs.services }}"
